---
title: "Analysis on Air Pollution in US Citites"
author: "Hieu Hoang"
date: "2025-05-29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

# Load libraries
library(HSAUR2)
library(ggplot2)
library(dplyr)
library(tools)
library(MASS)  # For LDA/QDA
library(klaR)  # For Box's M test
library(psych) # For pairs.panels
library(corrplot) # For correlation plots
library(heplots) # For Box's M test
```

```{r}
# Load the data
air_data <- USairpollution
air_data
```

```{r}
# Basic data exploration
str(air_data)
summary(air_data)
```

```{r}
# Create a correlation matrix
cor_matrix <- cor(air_data)
cor_matrix

# Visualize correlation matrix
corrplot(cor_matrix, method = "color", type = "upper", 
         tl.col = "black", tl.srt = 45, addCoef.col = "black")
```

```{r}
# Create pairs plot to visualize relationships between variables
pairs.panels(air_data, 
             method = "pearson", 
             hist.col = "#00AFBB",
             density = TRUE, 
             ellipses = TRUE)
```

```{r}
# Create boxplots for each variable
par(mfrow = c(2, 4))
for(i in 1:ncol(air_data)) {
  boxplot(air_data[,i], main = names(air_data)[i], col = "lightblue")
}
par(mfrow = c(1, 1))
```

```{r}
# Create scatterplots of SO2 against each predictor
par(mfrow = c(2, 3))
for(i in 2:ncol(air_data)) {
  plot(air_data[,i], air_data$SO2, 
       xlab = names(air_data)[i], 
       ylab = "SO2", 
       main = paste("SO2 vs", names(air_data)[i]),
       pch = 19, col = "blue")
  abline(lm(air_data$SO2 ~ air_data[,i]), col = "red")
}
par(mfrow = c(1, 1))
```

```{r}
# Create a heatmap of the data
# First, scale the data
scaled_data <- scale(air_data)
heatmap(as.matrix(scaled_data), 
        col = colorRampPalette(c("blue", "white", "red"))(100),
        main = "Heatmap of Air Pollution Data",
        xlab = "Variables", 
        ylab = "Cities")
```

```{r}
# Create a barplot of SO2 levels by city
# Sort cities by SO2 level
sorted_data <- air_data[order(air_data$SO2, decreasing = TRUE),]
barplot(sorted_data$SO2, 
        names.arg = rownames(sorted_data),
        las = 2, 
        cex.names = 0.7,
        col = "steelblue",
        main = "SO2 Levels by City",
        ylab = "SO2 (micrograms per cubic meter)")
```

```{r}
# Prepare for multivariate analysis by categorizing cities by pollution level
# Create a new variable for pollution level based on SO2 quartiles
air_data$pollution_level <- cut(air_data$SO2, 
                               breaks = quantile(air_data$SO2, probs = c(0, 0.25, 0.5, 0.75, 1)),
                               labels = c("Very Low", "Low", "Medium", "High"),
                               include.lowest = TRUE)

# Check the distribution of pollution levels
table(air_data$pollution_level)

# Visualize the distribution of pollution levels
barplot(table(air_data$pollution_level), 
        col = c("green", "lightgreen", "orange", "red"),
        main = "Distribution of Pollution Levels",
        xlab = "Pollution Level",
        ylab = "Number of Cities")
```

```{r}
# Multivariate Analysis: LDA and QDA
# First, check if we can use LDA by testing if covariance matrices are equal
# Box's M Test
res <- boxM(air_data[, 1:7], air_data$pollution_level)
res
summary(res)

# If Box's M test suggests different covariance matrices, use QDA
# Otherwise, use LDA
```

```{r}
# Split data into training and testing sets
set.seed(123)
ind <- sample(2, nrow(air_data),
              replace = TRUE,
              prob = c(0.6, 0.4))
training <- air_data[ind==1,]
testing <- air_data[ind==2,]

# Check dimensions
dim(air_data)
dim(training)
dim(testing)
```

```{r}
# Apply LDA
linear <- lda(pollution_level ~ ., data = training)
linear

# Visualize LDA
partimat(pollution_level ~ ., data = training, method = "lda")
```

```{r}
# Make predictions on training data
p1 <- predict(linear, training)$class
tab <- table(Predicted = p1, Actual = training$pollution_level)
tab

# Make predictions on testing data
p2 <- predict(linear, testing)$class
tab1 <- table(Predicted = p2, Actual = testing$pollution_level)
tab1

# Calculate accuracy
sum(diag(tab1))/sum(tab1)
```

```{r}
# Apply QDA
quadratic <- qda(pollution_level ~ ., data = training)
quadratic

# Visualize QDA
partimat(pollution_level ~ ., data = training, method = "qda")
```

```{r}
# Make predictions on training data using QDA
p1_qda <- predict(quadratic, training)$class
tab_qda <- table(Predicted = p1_qda, Actual = training$pollution_level)
tab_qda

# Make predictions on testing data using QDA
p2_qda <- predict(quadratic, testing)$class
tab1_qda <- table(Predicted = p2_qda, Actual = testing$pollution_level)
tab1_qda

# Calculate accuracy for QDA
sum(diag(tab1_qda))/sum(tab1_qda)
```

```{r}
# Compare LDA and QDA performance
cat("LDA Accuracy:", sum(diag(tab1))/sum(tab1), "\n")
cat("QDA Accuracy:", sum(diag(tab1_qda))/sum(tab1_qda), "\n")
```

```{r}
# Principal Component Analysis (PCA)
# Compute correlation matrix
S <- cor(air_data[, 1:7])
S

# Compute eigenvalues and eigenvectors
val <- eigen(S)$values
val
vec <- eigen(S)$vectors
vec

# Scree plot
par(mfrow=c(1,2))
plot(val, type="b", main="Scree Plot")
screeplot(princomp(S), main="Scree Plot")

# Cumulative percentage plot
cumsum(val)/7
par(mfrow=c(1,1))
plot(cumsum(val)/7, type="b", main="Cumulative Percentage Plot")
```

```{r}
# Perform PCA
PCA <- princomp(air_data[, 1:7], cor=TRUE)
PCA
loadings(PCA)
summary(PCA)

# Biplots
par(mfrow=c(2,2))
biplot(PCA, choices=c(1,2))
biplot(PCA, choices=c(1,3))
biplot(PCA, choices=c(2,3))
biplot(PCA, choices=c(3,4))
```

```{r}
# Compute principal component scores
pc_scores <- predict(PCA)
pc_scores

# Add PC scores to the original data
air_data_with_pc <- cbind(air_data, pc_scores)

# Plot PC1 vs PC2 with pollution level
plot(pc_scores[,1], pc_scores[,2], 
     col = c("green", "lightgreen", "orange", "red")[as.numeric(air_data$pollution_level)],
     pch = 19,
     main = "PC1 vs PC2 by Pollution Level",
     xlab = "PC1",
     ylab = "PC2")
legend("topright", 
       legend = levels(air_data$pollution_level),
       col = c("green", "lightgreen", "orange", "red"),
       pch = 19)
```

```{r}
# Compute loadings for interpretation
loadings <- PCA$loadings
loadings

# Visualize loadings
par(mfrow=c(2,2))
for(i in 1:4) {
  barplot(loadings[,i], 
          main = paste("Loadings for PC", i),
          col = "steelblue",
          las = 2)
}
par(mfrow=c(1,1))
```

```{r}
# Compute correlation between original variables and PCs
cor_pc <- cor(air_data[, 1:7], pc_scores)
cor_pc

# Visualize correlations
corrplot(cor_pc, 
         method = "color", 
         type = "upper", 
         tl.col = "black", 
         tl.srt = 45, 
         addCoef.col = "black",
         main = "Correlation between Variables and PCs")
```
